function get_play_video_url() {
    var playvideourl = "";
    for (var i = 0; i < document.scripts.length; i++) {
        var tempsrc = document.scripts[i].src;
        if (tempsrc.indexOf("main.min.js") != -1) {
            playvideourl = tempsrc;
            var arrurl = playvideourl.split("?");
            playvideourl = arrurl[0];
            playvideourl = playvideourl.replace("js/hls/main.min.js", "");
            break;
        }
    }
    return playvideourl;
}

var etwvp = new Object();
etwvp.isEmpty = function(str) {
    if (str == "" || str == null || str == undefined) {
        return true;
    }
    return false;
};

etwvp.getProtocol = function() {
    //var protocolStr = document.location.protocol;
    //protocolStr = protocolStr.replace(":", "");
    //protocolStr = etwvp.isEmpty(protocolStr) || protocolStr == "http" ? "http" :"https";
    //protocolStr = "https";
    //return protocolStr;
    return "https";
};
var play_video_url = get_play_video_url();
etwvp.protocol = etwvp.getProtocol();
etwvp.jsqurl = play_video_url + "index.php?jsqbox/base";
var full_video_url = play_video_url.replace("http://", "").replace("https://", "");
var arr_vio = full_video_url.split("/");
etwvp.ip = arr_vio[0];
etwvp.db = null;

etwvp.getUrl = function(url, method, async, data, callback) {
    if (method == "" || method == null || method == undefined) {
        method = "GET";
    }
    try {
        var xmlhttp;
        if (window.ActiveXObject) {
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        } else {
            xmlhttp = new XMLHttpRequest();
        }
        xmlhttp.open(method, url, async);
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4) {
                if (xmlhttp.status == 200) {
                    callback(xmlhttp.responseText);
                }
            }
        };
        xmlhttp.send(data);
    } catch (ex) {
        if (window.XDomainRequest) {
            try {
                var xdr = new XDomainRequest();
                xdr.open(method, url);
                xdr.onload = function() {
                    callback(xdr.responseText);
                };
                xdr.onerror = function(er) {
                    console.log(er);
                };
                setTimeout(function() {xdr.send();}, 0);
            } catch (e) {}
        }
    }
};

//是否支持本地存储,支持返回true
etwvp.supportLocalStorage = function() {
    if (window.localStorage) {
        etwvp.db = window.localStorage;
        return true;
    } else {
        return false;
    }
};

/*
vid:视频层的ID
vpath:视频文件路径，不需要带文件扩展名
vdomain: 网址
vRedirectUrl 跳转页面
iscoundvideo 1是etwcloud video视频
*/
etwvp.init = function(vid, vpath, vdomain, vRedirectUrl, iscoundvideo) {
    var extension = '';
    var video = document.querySelector(vid);
    if (video == null) {
        return false;
    }
    if (iscoundvideo == undefined) {
        iscoundvideo = 0
    }
    var vposter = video.getAttribute("poster");
    if (etwvp.isEmpty(vpath)) {
        return false;
    } else {
        var arr = vpath.split('.');
        if (arr.length > 1) {
            extension = vpath.replace(arr[0], "");
        }
        vpath = vpath.replace(extension, "");
    }
    if (etwvp.isEmpty(vposter)) {
        vposter = etwvp.protocol + "://" + etwvp.ip + "/image/loading.png";
    }
    if (etwvp.isEmpty(vdomain)) {
        vdomain = window.location.hostname;
    }

    function recordVisit() {
        if (vdomain != window.location.hostname || etwvp.isEmpty(vRedirectUrl)) {
            //var jsqstr = "domain=" + encodeURIComponent(vdomain);
            //jsqstr+="&visite_url="+encodeURIComponent("http://"+vdomain+"#"+vpath);
            var jsqstr = "visite_url=" + encodeURIComponent(window.location.href);
            jsqstr += "&refer=" + encodeURIComponent(vpath);
            etwvp.getUrl(etwvp.jsqurl, "PUT", true, jsqstr, function () {
            });
        }
    }

    var isautoplay = false;
    var autoplay = video.getAttribute("data-autoplay");
    if (autoplay == "autoplay") {
        isautoplay = true;
        video.setAttribute("autoplay", "autoplay");
    }
    var controlsshow = true;
    var controls = video.getAttribute("data-controls");
    if (controls == "none") {
        controlsshow = false;
    } else {
        video.setAttribute("controls", "controls");
    }
    video.setAttribute("poster", vposter);
    video.setAttribute("webkit-playsinline", true);
    video.setAttribute("playsinline", true);
    video.style.width = "100%";
    var sobj = video.querySelectorAll("source");
    for (var i = 0; i < sobj.length; i++) {
        sobj[i].setAttribute("type", "video/mp4");
    }
    var plyrobj = null;
    var videoplayerhost = "";
    if (etwvp.supportLocalStorage()) {
        videoplayerhost = etwvp.db.getItem(vdomain + "videourl");
    }
    if (etwvp.isEmpty(videoplayerhost)) {
        etwvp.getUrl(etwvp.protocol + "://" + etwvp.ip + "/index.php?API/base&d=" + vdomain, "", false, null, function (vip) {
            var vipurl = vip;
            if (iscoundvideo == "1") {
                if (vip == "cn2tv.etwun.com") {
                    vipurl = "https://etwun.com";
                } else {
                    vipurl = "https://" + vdomain;
                }
            }
            plyrobj = startvideo(vipurl);
            if (etwvp.supportLocalStorage()) {
                etwvp.db.setItem(vdomain + "videourl", vip);
            }
        });
    } else {
        var vipurl = videoplayerhost;
        if (iscoundvideo == "1") {
            if (videoplayerhost == "cn2tv.etwun.com") {
                vipurl = "https://etwun.com";
            } else {
                vipurl = "https://" + vdomain;
            }
        }
        plyrobj = startvideo(vipurl);
    }

    function startvideo(vip) {
        var supp = Plyr.supported("video", "html5", true);
        if (vip != "") {
            if (iscoundvideo != "1") {
                vip = etwvp.protocol + "://" + vip;
            }
            if (supp.ui) {
                var op = {
                    autoplay: false,
                    iconUrl: etwvp.protocol + "://" + etwvp.ip + "/js/hls/plyr.svg",
                    blankVideo: etwvp.protocol + "://" + etwvp.ip + "/js/hls/blank.mp4",
                    resetOnEnd: true,
                    clickToPlay:true
                };
                if (!controlsshow) {
                    op.controls = ["play-large"];
                }
                var player = new Plyr(video, op);
                var arr = vpath.split("/");
                var filename = arr[arr.length - 1];
                if (Hls.isSupported()) {
                    var hls = new Hls({
                        autoStartLoad:true
                    });
                    hls.loadSource(vip + "/" + vpath + "/" + filename + ".m3u8");
                    hls.attachMedia(video);
					//hls.on(Hls.Events.MANIFEST_PARSED,function() {
                    //    video.play();
                    //    recordVisit();
                    //});
                    if (!isautoplay) {
                        player.on("play", function () {
                            hls.startLoad(0);
                            if (player.currentTime < 1) {
                                recordVisit();
                            }
                        });
                    }
                } else {
                    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)) {
                        video.src = vip + "/" + vpath + "/" + filename + ".m3u8";
                        recordVisit();
                    } else {
                        video.removeAttribute("autoplay");
                        video.src = vip + "/" + vpath + ".mp4";
                        recordVisit();
                    }
                }
                if (!etwvp.isEmpty(vRedirectUrl)) {
                    player.on("ended", function () {
                        window.location.href = vRedirectUrl;
                    });
                }
                return player;
            } else {
                video.src = vip + "/" + vpath + ".mp4";
                recordVisit();
            }
        }
        return null;
    }
    return plyrobj;
};

var cur_div = "";
jQuery(window).resize(function(){setTimeout(plyr_t,1000)});
function plyr_t(){if(jQuery("body").find(".plyr__control--pressed").length>0){var n=0;for(var i=0;i<jQuery("body").find(".plyr__control--pressed").length;i++){var parent_div=jQuery("body").find(".plyr__control--pressed").parent().parent();cur_div=parent_div.find("video").attr("id");var dataplyr=jQuery("body").find(".plyr__control--pressed").eq(i).attr("data-plyr");if(dataplyr!=undefined&&dataplyr=="fullscreen"){n=1;break}}if(cur_div!=''){if(n==1){jQuery("body").find("#"+cur_div).attr("style","max-height:inherit!important;")}else{jQuery("body").find("#"+cur_div).attr("style","")}}}}